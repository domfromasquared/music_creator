<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>RetroLoop Studio — Drum Sequencer + Piano Roll</title>
  <style>
    :root{
      --bg:#0f1115;
      --ink:#e9eef5;
      --muted:#97a3b6;

      --btn:#22283a;
      --btn2:#2a3150;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --groupA:#121a28;
      --groupB:#211a2f;
      --inactiveOverlay: rgba(0,0,0,0.38);
      --playheadOutline: rgba(255,255,255,0.30);
      --beatDivider: rgba(255,255,255,0.18);
      --dragOutline: rgba(255,255,255,0.45);
      --dragFill: rgba(255,255,255,0.10);

      --kick: rgba(255,139,90,0.95);
      --hat: rgba(124,255,178,0.92);
      --snare: rgba(88,166,255,0.92);
      --clap: rgba(255,255,255,0.88);

      --rollBg: rgba(0,0,0,.18);
      --rollStrip: rgba(0,0,0,.32);
      --gridLine: rgba(255,255,255,.06);
      --gridBeat: rgba(255,255,255,.14);

      --whiteKeyA: rgba(255,255,255,0.92);
      --whiteKeyB: rgba(255,255,255,0.82);
      --blackKeyA: rgba(12,14,20,0.98);
      --blackKeyB: rgba(22,24,32,0.98);
      --keyBorder: rgba(0,0,0,0.35);

      --rowWhiteA: rgba(255,255,255,.03);
      --rowWhiteB: rgba(255,255,255,.015);
      --rowBlack: rgba(0,0,0,.22);

      --pianoNote: rgba(124,255,178,.85);
      --bassNote: rgba(88,166,255,.80);
      --synthNote: rgba(255,139,90,.78);

      --knobFill: rgba(0,140,255,.95);
      --knobBg: rgba(0,0,0,.30);
      --knobGlow: rgba(0,140,255,.28);

      --knobFillPiano: rgba(124,255,178,.95);
      --knobGlowPiano: rgba(124,255,178,.28);

      --knobFillSynth: rgba(255,139,90,.95);
      --knobGlowSynth: rgba(255,139,90,.28);

      --knobFillBass: rgba(88,166,255,.95);
      --knobGlowBass: rgba(88,166,255,.28);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, #1b2040 0%, transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, #223022 0%, transparent 55%),
                  var(--bg);
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding: 18px;
    }
    h1{margin:0 0 6px 0; font-size:18px; letter-spacing:.2px}
    .sub{color:var(--muted); margin:0 0 16px 0; font-size:13px}

    .wrap{
      display:grid;
      grid-template-columns: 440px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.07);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title{
      font-size:13px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em
    }
    .bd{padding: 12px}

    button{
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--ink);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 9px 12px;
      font-weight: 700;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:disabled{opacity:.5; cursor:not-allowed}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--muted);
      display:flex; gap:8px; align-items:center;
    }
    input[type="range"]{width: 150px}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      padding:1px 6px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:8px;
      background: rgba(0,0,0,.25);
      color: var(--ink);
    }
    .hint{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.35}

    /* Drum */
    .drumGrid{
      display:grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap:10px;
      align-items:start;
      touch-action: none;
    }
    .trackNames{display:grid; gap:8px;}
    .trackName{
      height:40px;
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
      padding: 6px 8px;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .trackLabel{
      font-size:12px;
      color: var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      line-height:1;
      flex: 1 1 auto;
      min-width: 0;
    }

    .knobWrap{display:flex; align-items:center; justify-content:flex-end; gap:8px; flex: 0 0 auto;}
    .knob{
      width:34px;
      height:34px;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,.24)), var(--knobBg);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25), 0 0 0 2px rgba(0,0,0,.12);
      position:relative;
      touch-action:none;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .knob::before{
      content:"";
      position:absolute;
      inset:4px;
      border-radius:999px;
      background:
        conic-gradient(from 225deg,
          var(--knobFill) 0deg,
          var(--knobFill) var(--knobDeg),
          rgba(255,255,255,.10) var(--knobDeg),
          rgba(255,255,255,.10) 270deg
        );
      filter: drop-shadow(0 0 10px var(--knobGlow));
      mask: radial-gradient(circle, transparent 55%, #000 56%);
      -webkit-mask: radial-gradient(circle, transparent 55%, #000 56%);
    }
    .knobDot{
      position:absolute;
      left:50%;
      top:50%;
      width:4px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.85);
      transform-origin: 50% calc(100% + 4px);
      transform: translate(-50%,-90%) rotate(var(--knobRot));
      opacity:.9;
    }
    .knobVal{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      width: 44px;
      text-align:center;
    }

    .steps{
      display:grid;
      gap:8px;
      overflow:hidden;
      border-radius: 12px;
      min-width: 0;
    }
    .rowSteps{
      display:grid;
      gap:6px;
      height:40px;
      align-items:stretch;
      touch-action: none;
      width: 100%;
      min-width: 0;
    }
    .cell{
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: none;
      min-width: 0;
    }
    .cell.groupA{ background: var(--groupA); }
    .cell.groupB{ background: var(--groupB); }
    .cell::after{
      content:"";
      position:absolute;
      inset:0;
      background: var(--inactiveOverlay);
      opacity:.55;
      pointer-events:none;
    }
    .cell.on::after{opacity:.07}
    .cell.on.kick{ background: linear-gradient(180deg, var(--kick), rgba(255,139,90,0.45)); border-color: rgba(255,139,90,0.75); }
    .cell.on.hat{  background: linear-gradient(180deg, var(--hat),  rgba(124,255,178,0.30)); border-color: rgba(124,255,178,0.65); }
    .cell.on.snare{background: linear-gradient(180deg, var(--snare),rgba(88,166,255,0.30)); border-color: rgba(88,166,255,0.65); }
    .cell.on.clap{ background: linear-gradient(180deg, var(--clap), rgba(255,255,255,0.18)); border-color: rgba(255,255,255,0.45); }
    .cell.beatDivider{ box-shadow: inset -2px 0 0 rgba(255,255,255,0.18); }
    .cell.playhead{ outline: 2px solid rgba(255,255,255,0.30); outline-offset: 1px; }
    .cell.drag-hover{
      outline: 2px solid rgba(255,255,255,0.45);
      outline-offset: -2px;
      box-shadow: inset 0 0 0 999px rgba(255,255,255,0.10);
    }

    /* Piano roll */
    .rollHeaderRight{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding: 7px 14px;
      border-radius: 999px;
      font-size:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: background .15s ease, border-color .15s ease, color .15s ease, box-shadow .15s ease;
    }

    /* ✅ Instrument-color active states */
    .tab.active{ color: var(--ink); }
    .tab.active[data-roll="piano"]{
      background: rgba(124,255,178,.16);
      border-color: rgba(124,255,178,.45);
      box-shadow: 0 0 0 2px rgba(124,255,178,.12) inset;
    }
    .tab.active[data-roll="synth"]{
      background: rgba(255,139,90,.16);
      border-color: rgba(255,139,90,.45);
      box-shadow: 0 0 0 2px rgba(255,139,90,.12) inset;
    }
    .tab.active[data-roll="bass"]{
      background: rgba(88,166,255,.16);
      border-color: rgba(88,166,255,.45);
      box-shadow: 0 0 0 2px rgba(88,166,255,.12) inset;
    }

    .trKnobs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .trGroup{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.20);
    }
    .trLabel{
      font-size:12px;
      color: var(--muted);
      letter-spacing:.04em;
      user-select:none;
      white-space:nowrap;
    }
    .trKnob{ width:30px; height:30px; }
    .trVal{ width: 42px; }

    .rollWrap{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      overflow:hidden;
      touch-action: none;
    }
    canvas{display:block; width:100%; height:auto; touch-action:none}

    #midiFile{display:none}
  </style>
</head>

<body>
  <h1>RetroLoop Studio</h1>
  <p class="sub">
    4/4 • Drum sequencer + piano roll • Loop size:
    <span class="kbd" id="resText">1/64</span> • Keys: C3 → C5
  </p>

  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div class="title">Transport</div>
        <div class="btnRow">
          <button id="playBtn">Play</button>
          <button id="pauseBtn" disabled>Pause</button>
          <button id="stopBtn" disabled>Stop</button>
        </div>
      </div>

      <div class="bd">
        <div class="btnRow" style="margin-bottom:10px;">
          <div class="pill">
            <span style="min-width:38px;">BPM</span>
            <input id="bpm" type="range" min="70" max="180" value="115"/>
            <span id="bpmLabel" class="kbd">115</span>
          </div>

          <div class="pill">
            <span>Loop</span>
            <input id="resolution" type="range" min="0" max="2" step="1" value="2"/>
            <span id="resolutionLabel" class="kbd">1/64</span>
          </div>
        </div>

        <div class="btnRow" style="margin-bottom:10px;">
          <div class="pill">
            <span>Piano</span><input id="pianoVol" type="range" min="0" max="1" step="0.01" value="0.35"/>
          </div>
          <div class="pill">
            <span>Synth</span><input id="synthVol" type="range" min="0" max="1" step="0.01" value="0.32"/>
          </div>
          <div class="pill">
            <span>Bass</span><input id="bassVol" type="range" min="0" max="1" step="0.01" value="0.40"/>
          </div>
          <div class="pill">
            <span>Drum Bus</span><input id="drumVol" type="range" min="0" max="1" step="0.01" value="0.85"/>
          </div>
        </div>

        <div class="btnRow">
          <button id="loadDemo">Reload Demo</button>
          <button id="clearProject">Clear Project</button>
          <button id="importMidiBtn">Import MIDI</button>
          <input id="midiFile" type="file" accept=".mid,.midi" />
        </div>

        <p class="hint">
          <span class="kbd">Space</span> toggles Play/Pause (desktop).<br/>
          Auto demo loads from <span class="kbd">MIDI/</span> on GitHub Pages (relative paths).<br/>
          Mapping: <span class="kbd">pluck → Bass</span>, <span class="kbd">chords → Piano</span>, <span class="kbd">arp → Synth</span>.
        </p>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="title">Drum Sequencer</div>
        <div class="pill">
          <span>Loop</span>
          <span class="kbd" id="groupText">1/64</span>
        </div>
      </div>
      <div class="bd">
        <div class="drumGrid" id="drumGrid"></div>
      </div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <div class="hd">
        <div class="title">Piano Roll</div>
        <div class="rollHeaderRight">
          <div class="tabs">
            <div class="tab active" data-roll="piano">Piano</div>
            <div class="tab" data-roll="synth">Synth</div>
            <div class="tab" data-roll="bass">Bass</div>
          </div>

          <div class="trKnobs" aria-label="Transpose knobs">
            <div class="trGroup" data-inst="piano">
              <div class="trLabel">P Tr</div>
              <div class="knob trKnob" id="pianoTrKnob" style="--knobFill:var(--knobFillPiano);--knobGlow:var(--knobGlowPiano);">
                <div class="knobDot"></div>
              </div>
              <div class="knobVal trVal" id="pianoTrVal">0</div>
            </div>

            <div class="trGroup" data-inst="synth">
              <div class="trLabel">S Tr</div>
              <div class="knob trKnob" id="synthTrKnob" style="--knobFill:var(--knobFillSynth);--knobGlow:var(--knobGlowSynth);">
                <div class="knobDot"></div>
              </div>
              <div class="knobVal trVal" id="synthTrVal">0</div>
            </div>

            <div class="trGroup" data-inst="bass">
              <div class="trLabel">B Tr</div>
              <div class="knob trKnob" id="bassTrKnob" style="--knobFill:var(--knobFillBass);--knobGlow:var(--knobGlowBass);">
                <div class="knobDot"></div>
              </div>
              <div class="knobVal trVal" id="bassTrVal">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="bd">
        <div class="rollWrap">
          <canvas id="roll" width="1280" height="560"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.28/build/Midi.js"></script>

<script>
(() => {
  const RES_OPTIONS = [
    { label: "1/16", steps: 16 },
    { label: "1/32", steps: 32 },
    { label: "1/64", steps: 64 },
  ];
  const MASTER_STEPS = 64;

  const ROLL_BASE_MIDI = 48; // C3
  const ROLL_TOP_MIDI  = 72; // C5
  const ROLL_PITCHES   = (ROLL_TOP_MIDI - ROLL_BASE_MIDI) + 1;

  const drumNames = ["Kick", "Clap", "Hat", "Snare"];
  const drumKeys  = ["kick", "clap", "hat", "snare"];

  const MIDI_PATHS = {
    bass:  "MIDI/NW_EID_115_synth_pluck_nightlife_Abmaj.mid",
    piano: "MIDI/NW_EID_115_synth_chords_nightlife_Abmaj.mid",
    synth: "MIDI/NW_EID_115_synth_arp_nightlife_Abmaj.mid",
  };

  const transpose = { piano: 0, synth: 0, bass: 0 };

  function makeEmptyProject(){
    return {
      drums: {
        kick:  new Array(MASTER_STEPS).fill(false),
        clap:  new Array(MASTER_STEPS).fill(false),
        hat:   new Array(MASTER_STEPS).fill(false),
        snare: new Array(MASTER_STEPS).fill(false),
      },
      piano: Array.from({length: ROLL_PITCHES}, () => new Array(MASTER_STEPS).fill(0)),
      synth: Array.from({length: ROLL_PITCHES}, () => new Array(MASTER_STEPS).fill(0)),
      bass:  Array.from({length: ROLL_PITCHES}, () => new Array(MASTER_STEPS).fill(0)),
      drumVols: { kick:100, clap:85, hat:65, snare:92 },
    };
  }

  const project = makeEmptyProject();

  let LOOP_STEPS = 64;

  let ctx = null;
  let master = null, pianoBus = null, synthBus = null, bassBus = null, drumBus = null;
  const drumGains = { kick:null, clap:null, hat:null, snare:null };

  let isPlaying = false;
  let isPaused = false;
  let currentStep = 0;
  let nextNoteTime = 0;
  let timerId = null;

  let bpm = 115;
  const lookAhead = 0.025;
  const scheduleAhead = 0.12;

  const playBtn = document.getElementById("playBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const stopBtn = document.getElementById("stopBtn");

  const bpmEl = document.getElementById("bpm");
  const bpmLabel = document.getElementById("bpmLabel");

  const resEl = document.getElementById("resolution");
  const resLabel = document.getElementById("resolutionLabel");
  const resText = document.getElementById("resText");
  const groupText = document.getElementById("groupText");

  const pianoVol = document.getElementById("pianoVol");
  const synthVol = document.getElementById("synthVol");
  const bassVol = document.getElementById("bassVol");
  const drumVol = document.getElementById("drumVol");

  const pianoTrKnob = document.getElementById("pianoTrKnob");
  const synthTrKnob = document.getElementById("synthTrKnob");
  const bassTrKnob  = document.getElementById("bassTrKnob");

  const pianoTrVal = document.getElementById("pianoTrVal");
  const synthTrVal = document.getElementById("synthTrVal");
  const bassTrVal  = document.getElementById("bassTrVal");

  const loadDemoBtn = document.getElementById("loadDemo");
  const clearProjectBtn = document.getElementById("clearProject");
  const importMidiBtn = document.getElementById("importMidiBtn");
  const midiFileInput = document.getElementById("midiFile");

  const drumGridEl = document.getElementById("drumGrid");
  const rollCanvas = document.getElementById("roll");
  const g = rollCanvas.getContext("2d");

  // Tabs
  let activeRoll = "piano";
  document.querySelectorAll(".tab").forEach(t => {
    t.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      activeRoll = t.dataset.roll;
      drawRoll(isPlaying ? currentStep : -1);
    });
  });

  bpmEl.addEventListener("input", () => {
    bpm = Number(bpmEl.value);
    bpmLabel.textContent = String(bpm);
  });

  function isTypingTarget(el){
    if (!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || el.isContentEditable;
  }
  window.addEventListener("keydown", (e) => {
    if (e.code !== "Space") return;
    if (isTypingTarget(document.activeElement)) return;
    e.preventDefault();
    togglePlayPause();
  }, {passive:false});

  const AudioContext = window.AudioContext || window.webkitAudioContext;

  function ensureAudio(){
    if (ctx) return;

    ctx = new AudioContext();

    master = ctx.createGain();
    master.gain.value = 0.9;
    master.connect(ctx.destination);

    pianoBus = ctx.createGain();
    synthBus = ctx.createGain();
    bassBus = ctx.createGain();
    drumBus = ctx.createGain();

    pianoBus.gain.value = Number(pianoVol.value);
    synthBus.gain.value = Number(synthVol.value);
    bassBus.gain.value = Number(bassVol.value);
    drumBus.gain.value = Number(drumVol.value);

    drumGains.kick  = ctx.createGain(); drumGains.kick.gain.value  = 1;
    drumGains.clap  = ctx.createGain(); drumGains.clap.gain.value  = 1;
    drumGains.hat   = ctx.createGain(); drumGains.hat.gain.value   = 1;
    drumGains.snare = ctx.createGain(); drumGains.snare.gain.value = 1;

    drumGains.kick.connect(drumBus);
    drumGains.clap.connect(drumBus);
    drumGains.hat.connect(drumBus);
    drumGains.snare.connect(drumBus);

    pianoBus.connect(master);
    synthBus.connect(master);
    bassBus.connect(master);
    drumBus.connect(master);

    pianoVol.addEventListener("input", () => pianoBus.gain.value = Number(pianoVol.value));
    synthVol.addEventListener("input", () => synthBus.gain.value = Number(synthVol.value));
    bassVol.addEventListener("input", () => bassBus.gain.value = Number(bassVol.value));
    drumVol.addEventListener("input", () => drumBus.gain.value = Number(drumVol.value));
  }

  async function ensureRunning(){
    ensureAudio();
    if (ctx.state !== "running") await ctx.resume();
  }

  function midiToHz(midi){
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function playVoice(freq, time, dur, bus, wave, peak, cutoff){
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const lp = ctx.createBiquadFilter();

    osc.type = wave;
    osc.frequency.setValueAtTime(freq, time);

    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(peak, time + 0.01);

    const rel = Math.max(0.02, Math.min(0.18, dur * 0.25));
    gain.gain.exponentialRampToValueAtTime(0.0001, time + dur + rel);

    lp.type = "lowpass";
    lp.frequency.setValueAtTime(cutoff, time);

    osc.connect(lp).connect(gain).connect(bus);
    osc.start(time);
    osc.stop(time + dur + rel + 0.03);
  }

  async function previewMidi(midi){
    await ensureRunning();
    const now = ctx.currentTime + 0.001;

    if (activeRoll === "bass"){
      const hz = midiToHz(midi + transpose.bass);
      playVoice(hz, now, 0.12, bassBus, "triangle", 0.22, 1500);
      return;
    }
    if (activeRoll === "synth"){
      const hz = midiToHz(midi + transpose.synth);
      playVoice(hz, now, 0.12, synthBus, "sawtooth", 0.18, 5200);
      return;
    }
    const hz = midiToHz(midi + transpose.piano);
    playVoice(hz, now, 0.12, pianoBus, "square", 0.18, 4200);
  }

  let noiseBuf = null;
  function getNoiseBuffer(){
    if (noiseBuf) return noiseBuf;
    const len = ctx.sampleRate * 0.3;
    const b = ctx.createBuffer(1, len, ctx.sampleRate);
    const d = b.getChannelData(0);
    for (let i=0;i<len;i++) d[i] = Math.random()*2 - 1;
    noiseBuf = b;
    return b;
  }

  function playKick(time){
    const out = drumGains.kick;
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = "sine";
    osc.frequency.setValueAtTime(160, time);
    osc.frequency.exponentialRampToValueAtTime(50, time + 0.09);
    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(1.0, time + 0.004);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.14);
    osc.connect(gain).connect(out);
    osc.start(time); osc.stop(time + 0.16);
  }
  function playSnare(time){
    const out = drumGains.snare;
    const src = ctx.createBufferSource();
    src.buffer = getNoiseBuffer();
    const bp = ctx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(1800, time);
    bp.Q.setValueAtTime(0.8, time);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(0.9, time + 0.003);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.10);
    src.connect(bp).connect(gain).connect(out);
    src.start(time); src.stop(time + 0.12);
  }
  function playHat(time){
    const out = drumGains.hat;
    const src = ctx.createBufferSource();
    src.buffer = getNoiseBuffer();
    const hp = ctx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.setValueAtTime(7000, time);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.0001, time);
    gain.gain.exponentialRampToValueAtTime(0.35, time + 0.002);
    gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.04);
    src.connect(hp).connect(gain).connect(out);
    src.start(time); src.stop(time + 0.06);
  }
  function playClap(time){
    const out = drumGains.clap;
    const t = time;
    const src = ctx.createBufferSource();
    src.buffer = getNoiseBuffer();
    const bp = ctx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(2200, t);
    bp.Q.setValueAtTime(0.7, t);
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0.0001, t);
    gain.gain.exponentialRampToValueAtTime(0.55, t + 0.002);
    gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.07);
    src.connect(bp).connect(gain).connect(out);
    src.start(t); src.stop(t + 0.09);
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function rangesOverlap(aStart, aLen, bStart, bLen){
    const aEnd = aStart + aLen;
    const bEnd = bStart + bLen;
    return aStart < bEnd && bStart < aEnd;
  }
  function clearOverlaps(row, start, len){
    for (let s=0; s<MASTER_STEPS; s++){
      const l = row[s];
      if (l <= 0) continue;
      if (rangesOverlap(s, l, start, len)) row[s] = 0;
    }
  }
  function setNoteLength(grid, midi, start, len){
    const p = midi - ROLL_BASE_MIDI;
    if (p < 0 || p >= ROLL_PITCHES) return;
    len = Math.max(1, Math.min(len, MASTER_STEPS - start));
    const row = grid[p];
    clearOverlaps(row, start, len);
    row[start] = len;
  }
  function clearInstrumentGrid(grid){
    for (let p=0; p<ROLL_PITCHES; p++) grid[p].fill(0);
  }
  function getActiveGrid(){
    if (activeRoll === "bass") return project.bass;
    if (activeRoll === "synth") return project.synth;
    return project.piano;
  }
  function noteColor(){
    const css = (v)=>getComputedStyle(document.documentElement).getPropertyValue(v).trim();
    if (activeRoll === "bass") return css("--bassNote");
    if (activeRoll === "synth") return css("--synthNote");
    return css("--pianoNote");
  }

  function clearProject(){
    stopTransportOnly();
    const fresh = makeEmptyProject();
    drumKeys.forEach(k => project.drums[k] = fresh.drums[k].slice());
    for (let p=0; p<ROLL_PITCHES; p++){
      project.piano[p] = fresh.piano[p].slice();
      project.synth[p] = fresh.synth[p].slice();
      project.bass[p]  = fresh.bass[p].slice();
    }
    project.drumVols = { ...fresh.drumVols };
    buildDrumGrid();
    drawRoll(-1);
  }

  // ✅ Trap-ish demo drums on the MASTER 64-step grid.
  // Works with any LOOP_STEPS because the UI/loop just plays the selected slice.
  function setDemoDrumsTrap(){
    drumKeys.forEach(k => project.drums[k].fill(false));

    // Beat positions on 64-step bar: beat = 16 steps
    const b1=0, b2=16, b3=32, b4=48;

    // Clap + Snare on beat 3 (trap halftime)
    project.drums.snare[b3] = true;
    project.drums.clap[b3]  = true;

    // Quick pre-snare flam (very common)
    [b3-2, b3-1].forEach(s => project.drums.snare[clamp(s,0,63)] = true);

    // Kick syncopation (808-style)
    [
      b1+0,   // downbeat
      b1+6,   // push
      b1+12,  // push
      b2+3,   // sync
      b2+10,  // sync
      b3+0,   // layered with snare beat
      b3+6,
      b3+12,
      b4+4,
      b4+10,
      b4+14   // turnaround
    ].forEach(s => project.drums.kick[clamp(s,0,63)] = true);

    // Hats: 1/16 base (every 4 steps)
    for (let s=0; s<64; s+=4) proje
